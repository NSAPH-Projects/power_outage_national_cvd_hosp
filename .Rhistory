hour,
customers_out_hourly = customers_out_hourly_locf,
customers_served_total = downscaled_county_estimate
)]
id_percentile[, cut_point := quantile(customers_out_hourly, 0.999),
by = .(clean_state_name, clean_county_name, five_digit_fips, year)]
source("/Volumes/squirrel-utopia 2/power_outage_national_cvd_hosp/b06_identify_outages_percentile.R")
View(exposures_99_9_1_hr)
View(exposures_99_9_1_hr)
View(exposures_99_9_2_hr)
View(exposures_99_9_3_hr)
colnames(exposures_99_9_1_hr)
combined_df <- Reduce(function(x, y)
merge(x, y, by = c(
"clean_state_name", "clean_county_name", 'five_digit_fips', "day"
)), all_exposures)
all_exposures <- list(exposures_99_9_1_hr,
exposures_99_9_2_hr,
exposures_99_9_4_hr)
exposures_99_9_4_hr <- exposures_99_9_3_hr
all_exposures <- list(exposures_99_9_1_hr,
exposures_99_9_2_hr,
exposures_99_9_4_hr)
combined_df <- Reduce(function(x, y)
merge(x, y, by = c(
"clean_state_name", "clean_county_name", 'five_digit_fips', "day"
)), all_exposures)
View(combined_df)
write_fst(
combined_df,
here(
"data",
"power_outage_exposure_data_cleaning_output",
"days_exposed_unexposed_percentile_based_exposure.fst"
)
)
renv::snapshot()
percentile_based_exposure <- read_fst(
here(
'data',
"power_outage_exposure_data_cleaning_output",
"days_exposed_unexposed_percentile_based_exposure.fst"
)
)
pacman::p_load(tidyverse, data.table, fst)
percentile_based_exposure <- read_fst(
here(
'data',
"power_outage_exposure_data_cleaning_output",
"days_exposed_unexposed_percentile_based_exposure.fst"
)
)
pacman::p_load(here, tidyverse, data.table, fst)
percentile_based_exposure <- read_fst(
here(
'data',
"power_outage_exposure_data_cleaning_output",
"days_exposed_unexposed_percentile_based_exposure.fst"
)
)
binary_exposure <- read_fst(
here(
'data',
"power_outage_exposure_data_cleaning_output",
"all_days_exposed_unexposed.fst"
)
)
daily_hrs_out <- read_fst(
here(
'data',
"power_outage_exposure_data_cleaning_output",
"daily_hrs_out.fst"
)
)
View(binary_exposure)
View(daily_hrs_out)
View(percentile_based_exposure)
colnames(percentile_based_exposure)
colanmes(daily_hrs_out)
colnames(daily_hrs_out)
colnames(binary_exposure)
all_exposures <- percentile_based_exposure %>%
left_join(daily_hrs_out) %>%
left_join(binary_exposure)
View(all_exposures)
colnames(all_exposures)
skimr::skim(all_exposures)
install.packages(skimr)
renv::install('skimr')
renv::snapshot()
skimr::skim(all_exposures)
length(unique(all_exposures$five_digit_fips))
# Create analytic data
pacman::p_load(here, tidyverse, data.table, fst)
# Read --------------------------------------------------------------------
percentile_based_exposure <- read_fst(
here(
'data',
"power_outage_exposure_data_cleaning_output",
"days_exposed_unexposed_percentile_based_exposure.fst"
)
)
binary_exposure <- read_fst(
here(
'data',
"power_outage_exposure_data_cleaning_output",
"all_days_exposed_unexposed.fst"
)
)
daily_hrs_out <- read_fst(
here(
'data',
"power_outage_exposure_data_cleaning_output",
"daily_hrs_out.fst"
)
)
all_exposures <- percentile_based_exposure %>%
left_join(daily_hrs_out) %>%
left_join(binary_exposure)
all_exposures <-
all_exposures %>%
mutate(year = lubridate::year(day)) %>%
filter(year == 2018)
write_csv(
all_exposures,
here(
'data',
"power_outage_exposure_data_cleaning_output",
"analytic_exposure_data_2018.csv"
)
)
write_fst(
all_exposures,
here(
'data',
"power_outage_exposure_data_cleaning_output",
"analytic_exposure_data_2018.fst"
)
)
pacman::p_load(here, tidyverse, data.table, fst, arrow)
write_parquet(
all_exposures,
here(
'data',
"power_outage_exposure_data_cleaning_output",
"analytic_exposure_data_2018.parquet"
)
)
renv::remove(MASS)
renv::remove('MASS')
renv::snapshot()
renv::update()
pacman::p_load(arrow, tidyverse, here, sf, ggthemes, arrow)
meteo_vars <- read_parquet(here('data', 'meteo_vars.parquet'))
county_backbone <- read_rds(here("data", "cotus_county_shp_w_fips.RDS"))
us_counties <- readRDS(here("data", "counties_sf.RDS")) %>%
rename(five_digit_fips = county_fips) %>%
filter(five_digit_fips %in% county_backbone$five_digit_fips)
meteo_vars <- meteo_vars %>%
group_by(five_digit_fips) %>%
summarize(
mean_min_temp = mean(min_temp),
mean_max_temp = mean(max_temp),
max_precip = max(precip),
max_wind = max(wind_speed)
)
county_backbone <- county_backbone %>% left_join(meteo_vars)
p1 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = mean_min_temp, color = NA)) +
scale_fill_viridis_c(name = "Mean minimum temperature gridmet for 2018") +
theme_map() +
ggtitle(paste0('Mean minimum temp'))
ggsave(p1, here('figures', 'figures_output', 'plot_min_temp.png'))
ggsave(plot = p1, here('figures', 'figures_output', 'plot_min_temp.png'))
p1 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = mean_min_temp), color = NA) +
scale_fill_viridis_c(name = "Mean minimum temperature gridmet for 2018") +
theme_map() +
ggtitle(paste0('Mean minimum temp'))
ggsave(plot = p1, here('figures', 'figures_output', 'plot_min_temp.png'))
pdf(here("figures", "figures_output", "weather_vars.pdf"))
p1 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = mean_min_temp), color = NA) +
scale_fill_viridis_c(name = "Mean minimum temperature gridmet for 2018") +
theme_map() +
ggtitle(paste0('Mean minimum temp'))
print(p1)
p2 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = mean_max_temp, color = NA)) +
scale_fill_viridis_c(name = "Mean maximum temperature gridmet for 2018") +
theme_map() +
ggtitle(paste0('Mean maximum temp'))
print(p2)
p3 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = max_precip, color = NA)) +
scale_fill_viridis_c(name = "Maximum daily precipitation gridmet for 2018") +
theme_map() +
ggtitle(paste0('Max precip'))
print(p3)
p3 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = max_precip, color = NA)) +
scale_fill_viridis_c(name = "Maximum wind speed gridmet for 2018") +
theme_map() +
ggtitle(paste0('Max wind speed'))
print(p4)
p4 <- county_backbone |>
geom_sf(aes(fill = max_precip) +
theme_map() +
p4 <- county_backbone |>
)
p4 <- county_backbone |>
p4 <- county_backbone %>%
)
p4 <- county_backbone %>%
)
p4 <- county_backbone %>%
ggplot() +
geom_sf(aes(fill = max_precip) +
scale_fill_viridis_c(name = "Maximum wind speed gridmet for 2018") +
theme_map() +
ggtitle(paste0('Max wind speed'))
p4 <- county_backbone %>%
p4 <- county_backbone %>%
ggplot() +
geom_sf(aes(fill = max_precip)) +
scale_fill_viridis_c(name = "Maximum wind speed gridmet for 2018") +
theme_map() +
ggtitle(paste0('Max wind speed'))
print(p4)
dev.off()
# Plot gridmet data already cleaned by NSAPH
# Libraries ---------------------------------------------------------------
pacman::p_load(arrow, tidyverse, here, sf, ggthemes, arrow)
# Read --------------------------------------------------------------------
meteo_vars <- read_parquet(here('data', 'meteo_vars.parquet'))
county_backbone <- read_rds(here("data", "cotus_county_shp_w_fips.RDS"))
us_counties <- readRDS(here("data", "counties_sf.RDS")) %>%
rename(five_digit_fips = county_fips) %>%
filter(five_digit_fips %in% county_backbone$five_digit_fips)
pacman::p_load(arrow, tidyverse, here, sf, ggthemes, arrow)
meteo_vars <- read_parquet(here('data', 'meteo_vars.parquet'))
county_backbone <- read_rds(here("data", "cotus_county_shp_w_fips.RDS"))
meteo_vars <- meteo_vars %>%
group_by(five_digit_fips) %>%
summarize(
mean_min_temp = mean(min_temp),
mean_max_temp = mean(max_temp),
max_precip = max(precip),
max_wind = max(wind_speed)
)
county_backbone <- county_backbone %>% left_join(meteo_vars)
pdf(here("figures", "figures_output", "weather_vars.pdf"))
p1 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = mean_min_temp), color = NA) +
scale_fill_viridis_c(name = "Mean minimum temperature gridmet for 2018") +
theme_map() +
ggtitle(paste0('Mean minimum temp'))
print(p1)
p2 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = mean_max_temp)) +
scale_fill_viridis_c(name = "Mean maximum temperature gridmet for 2018") +
theme_map() +
ggtitle(paste0('Mean maximum temp'))
print(p2)
p3 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = max_precip)) +
scale_fill_viridis_c(name = "Maximum daily precipitation gridmet for 2018") +
theme_map() +
ggtitle(paste0('Max precip'))
print(p3)
p4 <- county_backbone %>%
ggplot() +
geom_sf(aes(fill = max_precip)) +
scale_fill_viridis_c(name = "Maximum wind speed gridmet for 2018") +
theme_map() +
ggtitle(paste0('Max wind speed'))
print(p4)
dev.off()
# Plot gridmet data already cleaned by NSAPH
# Libraries ---------------------------------------------------------------
pacman::p_load(arrow, tidyverse, here, sf, ggthemes, arrow)
# Read --------------------------------------------------------------------
meteo_vars <- read_parquet(here('data', 'meteo_vars.parquet'))
county_backbone <- read_rds(here("data", "cotus_county_shp_w_fips.RDS"))
# Plot real quick ---------------------------------------------------------
meteo_vars <- meteo_vars %>%
group_by(five_digit_fips) %>%
summarize(
mean_min_temp = mean(min_temp),
mean_max_temp = mean(max_temp),
max_precip = max(precip),
max_wind = max(wind_speed)
)
county_backbone <- county_backbone %>% left_join(meteo_vars)
pdf(here("figures", "figures_output", "weather_vars.pdf"))
p1 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = mean_min_temp), color = NA) +
scale_fill_viridis_c(name = "Mean minimum temperature gridmet for 2018") +
theme_map() +
ggtitle(paste0('Mean minimum temp'))
#ggsave(plot = p1, here('figures', 'figures_output', 'plot_min_temp.png'))
print(p1)
p2 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = mean_max_temp), color = NA) +
scale_fill_viridis_c(name = "Mean maximum temperature gridmet for 2018") +
theme_map() +
ggtitle(paste0('Mean maximum temp'))
print(p2)
p3 <- county_backbone |>
ggplot() +
geom_sf(aes(fill = max_precip), color = NA) +
scale_fill_viridis_c(name = "Maximum daily precipitation gridmet for 2018") +
theme_map() +
ggtitle(paste0('Max precip'))
print(p3)
p4 <- county_backbone %>%
ggplot() +
geom_sf(aes(fill = max_precip), color = NA) +
scale_fill_viridis_c(name = "Maximum wind speed gridmet for 2018") +
theme_map() +
ggtitle(paste0('Max wind speed'))
print(p4)
dev.off()
pacman::p_load(arrow, data.table, tidyverse, here, fst)
outages <- read_parquet(
here(
'data',
'power_outage_exposure_data_cleaning_output',
'analytic_exposure_data_all_years.parquet'
)
)
denoms <- read_fst(
here(
'data',
'power_outage_exposure_data_cleaning_output',
"county_customer_denoms_and_p_missing.fst"
)
)
outages <- outages %>% left_join(denoms)
outages <- outages %>% filter(percent_served > 0.5 & county_customers > 1000)
p1 <-
outages %>%
ggplot() +
geom_point(aes(x = day, y = n_hrs_out_0.01), alpha = 0.2)
ggsave(p1, filename= here('figures', 'figures_output', 'outages_by_day.png'))
p1 <-
outages %>%
ggplot() +
geom_point(aes(x = day, y = n_hrs_out_0.01), alpha = 0.01)
ggsave(p1, filename= here('figures', 'figures_output', 'outages_by_day.png'))
p1 <-
outages %>%
ggplot() +
geom_point(aes(x = day, y = n_hrs_out_0.01), alpha = 0.01, size = 5)
ggsave(p1, filename= here('figures', 'figures_output', 'outages_by_day.png'))
7/8
pacman::p_load(arrow, data.table, tidyverse, here, fst)
outages <- read_parquet(
here(
'data',
'power_outage_exposure_data_cleaning_output',
'analytic_exposure_data_all_years.parquet'
)
)
denoms <- read_fst(
here(
'data',
'power_outage_exposure_data_cleaning_output',
"county_customer_denoms_and_p_missing.fst"
)
)
outages <- outages %>% left_join(denoms)
outages <- outages %>% filter(percent_served > 0.5 & county_customers > 1000)
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(mean_outages = mean(exposed_8_hrs_0.005))
View(p2)
p2 <- p2 %>%
ggplot() +
geom_point(aes(x = month, y = mean_outages)) + facet_grid( ~ year)
ggsave(p2,
filename = here('figures', 'figures_output', 'mean_outages_by_weekday.png'))
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(mean_outages = mean(exposed_8_hrs_0.005))
p2 <- p2 %>%
ggplot() +
geom_point(aes(x = month, y = mean_outages)) + facet_grid( ~ year)
ggsave(p2,
filename = here('figures', 'figures_output', 'mean_outages_by_weekday.png'))
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(mean_outages = mean(exposed_8_hrs_0.005))
p2 <- p2 %>%
ggplot() +
geom_point(aes(x = month, y = mean_outages)) + facet_grid( ~ year)
p2
p2 <- p2 %>%
ggplot() +
geom_point(aes(x = day_of_week, y = mean_outages)) + facet_grid( ~ year)
p2
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(mean_outages = mean(exposed_8_hrs_0.005))
p2
p2 <- p2 %>%
ggplot() +
geom_point(aes(x = day_of_week, y = mean_outages)) + facet_grid( ~ year)
p2
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(mean_outages = sum(exposed_8_hrs_0.005))
p2 <- p2 %>%
ggplot() +
geom_point(aes(x = day_of_week, y = mean_outages)) + facet_grid( ~ year)
p2
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(mean_outages = sum(exposed_8_hrs_0.005))
p2 <- p2 %>%
ggplot() +
geom_point(aes(x = day_of_week, y = mean_outages)) +
geom_jitter(alpha = 0.5, size = 3) +
facet_grid( ~ year)
p2
p2 <- p2 %>%
ggplot() +
geom_jitter(aes(x = day_of_week, y = mean_outages), alpha = 0.5, size = 3) +
facet_grid( ~ year)
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(mean_outages = sum(exposed_8_hrs_0.005))
p2 <- p2 %>%
ggplot() +
geom_jitter(aes(x = day_of_week, y = mean_outages), alpha = 0.5, size = 3) +
facet_grid( ~ year)
p2
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(mean_outages = sum(exposed_8_hrs_0.005))
p2 <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(num_outages = sum(exposed_8_hrs_0.005))
p2 <- p2 %>% group_by(day_of_week) %>% summarize(n = mean(num_outages))
View(p2)
?wday
pacman::p_load(arrow, data.table, tidyverse, here, fst)
outages <- read_parquet(
here(
'data',
'power_outage_exposure_data_cleaning_output',
'analytic_exposure_data_all_years.parquet'
)
)
denoms <- read_fst(
here(
'data',
'power_outage_exposure_data_cleaning_output',
"county_customer_denoms_and_p_missing.fst"
)
)
outages <- outages %>% left_join(denoms)
outages <- outages %>% filter(percent_served > 0.5 & county_customers > 1000)
day_of_week <- outages %>%
mutate(day_of_week = lubridate::wday(day)) %>%
group_by(five_digit_fips, year, day_of_week) %>%
summarize(num_outages = sum(exposed_8_hrs_0.005))
day_of_week %>%
group_by(day_of_week) %>%
summarize(n = mean(num_outages)) %>%
knitr::kable()
p2 <- day_of_week %>%
ggplot() +
geom_jitter(aes(x = day_of_week, y = mean_outages),
alpha = 0.5,
size = 3) +
facet_grid(~ year)
p2
p2 <- day_of_week %>%
ggplot() +
geom_jitter(aes(x = day_of_week, y = num_outages),
alpha = 0.5,
size = 3) +
facet_grid(~ year)
p2
p2 <- day_of_week %>%
ggplot() +
geom_jitter(aes(x = day_of_week, y = num_outages),
alpha = 0.02,
size = 3) +
facet_grid(~ year)
p2
